#!/bin/bash
# shellcheck source=base.bash
source /dev/null; eval "$(cat "$(dirname -- "$0")/base.bash")"

declare name status

for suite in "$PWD"/**/*.tests; do
  echo "$suite" >&2
  for test in "$suite"/1.bash; do
    echo "$test" >&2
    name="${test%.*}"
    rm -rf "$name.status.txt"
    rm -rf "$name.stdout.txt"
    rm -rf "$name.stderr.txt"
    if [[ ! -e "$name.stdin.txt" ]]; then
      touch "$name.stdin.txt"
    fi
    bash "$test" <"$name.stdin.txt" 1>"$name.stdout.txt" 2>"$name.stderr.txt"
    echo "$?" > "$name.status.txt"
  done
  git add "$suite"
  git --no-pager diff HEAD -- "$suite"
done
